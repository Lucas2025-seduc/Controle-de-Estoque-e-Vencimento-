<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Enterprise 2.0 - Gestão de Estoque</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Sistema profissional de gestão de estoque, entradas, saídas e relatórios.">
    <link rel="manifest" href="./manifest.json">
    
    <!-- Ícones e Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .card-hover { transition: all 0.2s ease-in-out; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #6366f1; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos de Impressão Profissional */
        @media print {
            @page { size: A4; margin: 1cm; }
            body { background: white; font-size: 10pt; color: black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print, nav, .fixed, button, #toast, #filterType, #filterStatus, #searchInput, .card-actions { display: none !important; }
            #reportModal { position: static !important; display: block !important; background: white !important; height: auto !important; overflow: visible !important; }
            #reportContent { box-shadow: none !important; max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 9pt; }
            th, td { border: 1px solid #cbd5e1; padding: 6px; text-align: left; }
            th { background-color: #f1f5f9 !important; font-weight: bold; text-transform: uppercase; font-size: 8pt; }
            .page-break { page-break-before: always; }
            
            /* Cores de Fundo para Impressão */
            .print-bg-black { background-color: #000 !important; color: #fff !important; }
            .print-bg-red { background-color: #fee2e2 !important; color: #991b1b !important; }
            .print-bg-orange { background-color: #ffedd5 !important; color: #9a3412 !important; }
            .print-bg-yellow { background-color: #fef9c3 !important; color: #854d0e !important; }
            .print-bg-green { background-color: #dcfce7 !important; color: #166534 !important; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Navegação -->
    <nav class="bg-slate-900 text-white shadow-lg z-50 no-print flex-shrink-0">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="openLicenseModal()">
                <div class="relative">
                    <div class="bg-indigo-600 p-2 rounded-lg"><i class="fa-solid fa-cube text-xl"></i></div>
                    <div id="licenseDot" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-slate-900 animate-pulse"></div>
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-tight">Nexus 2.0 <span id="proBadge" class="hidden text-[10px] bg-amber-500 px-1 rounded ml-1 text-black">PRO</span></h1>
                    <p class="text-[10px] text-slate-400">Gestão Inteligente</p>
                </div>
            </div>
            
            <div class="flex gap-2 md:gap-3">
                <button onclick="openMovementModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 md:px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 shadow-lg hover:shadow-emerald-500/30">
                    <i class="fa-solid fa-right-left"></i> <span class="hidden md:inline">Movimentar</span>
                </button>
                
                <button onclick="generateReport()" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 px-3 py-2 rounded-lg transition text-slate-200" title="Relatórios">
                    <i class="fa-solid fa-file-pdf"></i>
                </button>
                
                <button onclick="openDataModal()" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 px-3 py-2 rounded-lg transition text-slate-200" title="Dados">
                    <i class="fa-solid fa-database"></i>
                </button>

                <button onclick="checkLimitAndOpenModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 md:px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 shadow-lg hover:shadow-indigo-500/30">
                    <i class="fa-solid fa-plus"></i> <span class="hidden md:inline">Novo Item</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Banner Versão Gratuita -->
    <div id="licenseStatusBanner" class="bg-slate-800 text-slate-300 text-xs text-center py-1 no-print cursor-pointer hover:bg-slate-700 transition flex-shrink-0" onclick="openLicenseModal()">
        Versão Gratuita: <span id="freeCountDisplay">0</span>/5 itens. <span class="text-amber-400 underline ml-1">Ativar PRO</span>
    </div>

    <!-- Conteúdo Principal Scrollável -->
    <div class="flex-grow overflow-y-auto custom-scrollbar p-4 bg-slate-100" id="mainContent">
        <div class="container mx-auto max-w-7xl pb-20">
            
            <!-- Dashboard Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <p class="text-slate-500 text-[10px] font-bold uppercase">Patrimônio</p>
                    <h3 class="text-xl md:text-2xl font-bold text-slate-800" id="stat-total-value">R$ 0,00</h3>
                    <i class="fa-solid fa-sack-dollar text-emerald-500 absolute top-4 right-4 opacity-20 text-4xl"></i>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <p class="text-slate-500 text-[10px] font-bold uppercase">Itens</p>
                    <h3 class="text-xl md:text-2xl font-bold text-slate-800" id="stat-total-items">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <p class="text-slate-500 text-[10px] font-bold uppercase">Reposição</p>
                    <h3 class="text-xl md:text-2xl font-bold text-orange-600" id="stat-low-stock">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <p class="text-slate-500 text-[10px] font-bold uppercase">Vencidos/Risco</p>
                    <h3 class="text-xl md:text-2xl font-bold text-red-600" id="stat-expiring">0</h3>
                </div>
            </div>

            <!-- Filtros e Busca -->
            <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 mb-6 sticky top-0 z-30">
                <div class="flex flex-col md:flex-row gap-3">
                    <div class="relative flex-grow flex gap-2">
                        <div class="relative flex-grow">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="searchInput" oninput="renderItems()" placeholder="Buscar produto..." class="w-full pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <button onclick="startScanner('search')" class="bg-slate-100 px-3 py-2 rounded-lg border border-slate-300 text-slate-600 hover:text-indigo-600 transition"><i class="fa-solid fa-barcode"></i></button>
                    </div>
                    <div class="flex gap-2 overflow-x-auto">
                        <select id="filterType" onchange="renderItems()" class="px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-50 outline-none">
                            <option value="all">Tipos: Todos</option>
                            <option value="product">Produtos</option>
                            <option value="material">Matéria Prima</option>
                        </select>
                        <select id="filterStatus" onchange="renderItems()" class="px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-50 outline-none">
                            <option value="all">Status: Todos</option>
                            <option value="expired">Vencidos (Preto)</option>
                            <option value="7days">Vence 7 dias (Vermelho)</option>
                            <option value="15days">Vence 15 dias (Laranja)</option>
                            <option value="30days">Vence 30 dias (Amarelo)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Grid de Produtos -->
            <div id="itemsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Items injetados via JS -->
            </div>
            
            <div id="emptyState" class="hidden text-center py-20 text-slate-400">
                <i class="fa-solid fa-box-open text-4xl mb-3 opacity-50"></i>
                <p>Nenhum item encontrado.</p>
            </div>
        </div>
    </div>

    <!-- MODAL DE MOVIMENTAÇÃO -->
    <div id="movementModal" class="fixed inset-0 bg-slate-900/90 hidden z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-slate-800 p-4 flex justify-between items-center text-white">
                <h2 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-right-left"></i> Registrar Movimentação</h2>
                <button onclick="closeMovementModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto bg-slate-50">
                <form id="movementForm" onsubmit="handleMovementSubmit(event)" class="space-y-4">
                    
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">1. Identificar Produto</label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="movSearch" placeholder="Digite Nome, Código ou ID..." class="flex-grow px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" oninput="searchProductForMovement()">
                            <button type="button" onclick="startScanner('movement')" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200 transition font-medium"><i class="fa-solid fa-barcode"></i> Ler</button>
                        </div>
                        
                        <div id="movProductCard" class="hidden bg-indigo-50 border border-indigo-100 rounded-lg p-3 flex gap-3 items-center mt-2 animate-fade-in">
                            <input type="hidden" id="movItemId" required>
                            <div id="movProductImg" class="w-12 h-12 bg-white rounded flex-shrink-0 flex items-center justify-center text-slate-300 text-xs border border-indigo-100">Foto</div>
                            <div class="flex-grow">
                                <h4 id="movProductName" class="font-bold text-indigo-900 text-sm">Nome do Produto</h4>
                                <p class="text-xs text-indigo-700">Estoque Atual: <strong id="movCurrentStock">0</strong> <span id="movUnit">UN</span></p>
                            </div>
                            <button type="button" onclick="clearMovSelection()" class="text-indigo-400 hover:text-indigo-700"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div id="movSearchResults" class="hidden mt-2 max-h-40 overflow-y-auto border border-slate-200 rounded-lg bg-white shadow-lg absolute w-[90%] md:w-[600px] z-50"></div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm opacity-50 pointer-events-none transition" id="movDetailsSection">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">2. Dados da Operação</label>
                        
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">Tipo de Movimento</label>
                                <select id="movType" class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none font-bold text-slate-700" onchange="updateMovLabels()">
                                    <option value="in" class="text-green-600">Entrada (+)</option>
                                    <option value="out" class="text-red-600">Saída (-)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">Quantidade</label>
                                <input type="number" step="any" id="movQty" required min="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none font-bold text-lg text-slate-800" placeholder="0.00">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="block text-xs text-slate-500 mb-1" id="labelSourceDest">Origem / Fornecedor</label>
                            <input type="text" id="movSourceDest" class="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none text-sm" placeholder="Ex: Fornecedor ABC ou Setor de Montagem">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">Data</label>
                                <input type="date" id="movDate" required class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-slate-600">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">Hora</label>
                                <input type="time" id="movTime" required class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-slate-600">
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeMovementModal()" class="w-1/3 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-lg font-medium transition">Cancelar</button>
                        <button type="submit" id="btnConfirmMov" disabled class="w-2/3 bg-slate-400 text-white py-3 rounded-lg font-bold transition shadow-md flex items-center justify-center gap-2 cursor-not-allowed">
                            <i class="fa-solid fa-check"></i> Confirmar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro Item -->
    <div id="itemModal" class="fixed inset-0 bg-slate-900/80 hidden z-[100] flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col animate-fade-in">
            <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center text-white">
                <h2 class="text-lg font-bold"><i class="fa-solid fa-box"></i> <span id="modalTitle">Ficha do Produto</span></h2>
                <button onclick="closeModal()" class="hover:text-slate-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="overflow-y-auto p-6 bg-slate-50 custom-scrollbar">
                <form id="itemForm" onsubmit="handleFormSubmit(event)">
                    <input type="hidden" id="itemId">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- Imagem -->
                        <div class="w-full md:w-1/3 flex flex-col items-center">
                            <div class="relative group cursor-pointer w-full aspect-square max-w-[200px] rounded-xl overflow-hidden border-2 border-dashed border-slate-300 bg-white hover:border-indigo-500 transition-colors" onclick="document.getElementById('itemImageInput').click()">
                                <div id="imagePreview" class="w-full h-full flex flex-col items-center justify-center text-slate-400">
                                    <i class="fa-solid fa-camera text-3xl mb-2"></i>
                                    <span class="text-xs">Adicionar Foto</span>
                                </div>
                            </div>
                            <input type="file" id="itemImageInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                            <button type="button" onclick="clearImage()" class="mt-2 text-xs text-red-500 hover:underline hidden" id="btnClearImage">Remover Foto</button>
                        </div>

                        <!-- Dados -->
                        <div class="w-full md:w-2/3 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="label-text">Nome do Item</label>
                                <input type="text" id="itemName" required class="input-field" placeholder="Ex: Parafuso 10mm">
                            </div>

                            <div>
                                <label class="label-text">Código de Barras</label>
                                <div class="flex gap-1">
                                    <input type="text" id="itemBarcode" class="input-field" placeholder="EAN/GTIN">
                                    <button type="button" onclick="startScanner('form')" class="bg-slate-200 px-3 rounded-lg text-slate-600 hover:bg-slate-300"><i class="fa-solid fa-barcode"></i></button>
                                </div>
                            </div>

                            <div>
                                <label class="label-text">Tipo / Categoria</label>
                                <select id="itemType" class="input-field bg-white">
                                    <option value="product">Produto Final</option>
                                    <option value="material">Matéria Prima</option>
                                </select>
                            </div>

                            <div>
                                <label class="label-text">Localização / Prateleira</label>
                                <input type="text" id="itemLocation" class="input-field" placeholder="Ex: Corredor A, Prat. 2">
                            </div>

                            <div>
                                <label class="label-text">Preço Unitário (R$)</label>
                                <input type="number" step="0.01" id="itemPrice" required class="input-field" placeholder="0.00">
                            </div>

                            <div>
                                <label class="label-text">Estoque Inicial</label>
                                <div class="flex">
                                    <input type="number" step="any" id="itemQty" required class="input-field rounded-r-none border-r-0" placeholder="0">
                                    <select id="itemUnit" class="bg-slate-100 border border-slate-300 rounded-r-lg text-xs px-2 outline-none font-bold text-slate-600">
                                        <option value="un">UN</option>
                                        <option value="kg">KG</option>
                                        <option value="l">LT</option>
                                        <option value="m">MT</option>
                                        <option value="cx">CX</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="label-text">Estoque Mínimo</label>
                                <input type="number" step="any" id="itemMinStock" required class="input-field" placeholder="Alerta">
                            </div>

                            <div class="md:col-span-2 bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                                <h4 class="text-xs font-bold text-indigo-800 mb-2 flex items-center gap-2"><i class="fa-regular fa-clock"></i> Controle de Validade</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="label-text">Vencimento</label>
                                        <input type="date" id="itemExpiry" class="input-field text-xs">
                                    </div>
                                    <div>
                                        <label class="label-text">Anotações / Obs</label>
                                        <input type="text" id="itemNotes" class="input-field text-xs" placeholder="Ex: Lote 123">
                                    </div>
                                </div>
                                <p class="text-[10px] text-slate-500 mt-2 italic">* O sistema aplicará cores automaticamente (Preto, Vermelho, Laranja, Amarelo, Verde).</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-white p-4 border-t border-slate-200 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-5 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium transition">Cancelar</button>
                <button onclick="document.getElementById('itemForm').requestSubmit()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow transition transform active:scale-95">Salvar Item</button>
            </div>
        </div>
    </div>

    <!-- Modal Relatório -->
    <div id="reportModal" class="fixed inset-0 bg-slate-900/50 hidden z-[200] overflow-y-auto backdrop-blur-sm">
        <div class="min-h-screen p-4 flex justify-center">
            <div id="reportContent" class="bg-white w-full max-w-4xl shadow-2xl rounded-lg overflow-hidden my-4 relative">
                <!-- Header Relatório -->
                <div class="bg-slate-900 text-white p-4 no-print flex justify-between items-center sticky top-0 z-10">
                    <h3 class="font-bold">Visualização de Impressão</h3>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded shadow text-sm font-bold flex items-center gap-2"><i class="fa-solid fa-print"></i> Imprimir / PDF</button>
                        <button onclick="closeReport()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded shadow text-sm">Fechar</button>
                    </div>
                </div>

                <div class="p-8 md:p-12">
                    <!-- Cabeçalho Impresso -->
                    <div class="border-b-4 border-slate-800 pb-4 mb-6 flex justify-between items-end">
                        <div>
                            <h1 class="text-3xl font-bold text-slate-900 uppercase tracking-tight">Relatório Gerencial</h1>
                            <p class="text-slate-500 text-sm mt-1">Nexus Enterprise 2.0 - Controle de Estoque</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-slate-700">Emissão</p>
                            <p class="text-lg text-slate-900" id="reportDate">00/00/0000</p>
                        </div>
                    </div>

                    <!-- Resumo -->
                    <div class="grid grid-cols-4 gap-4 mb-8 bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <div class="text-center">
                            <p class="text-xs text-slate-500 uppercase">Valor em Estoque</p>
                            <p class="text-xl font-bold text-slate-800" id="rep-total">-</p>
                        </div>
                        <div class="text-center border-l border-slate-200">
                            <p class="text-xs text-slate-500 uppercase">Itens Totais</p>
                            <p class="text-xl font-bold text-indigo-600" id="rep-items">-</p>
                        </div>
                        <div class="text-center border-l border-slate-200">
                            <p class="text-xs text-slate-500 uppercase">Itens Vencidos</p>
                            <p class="text-xl font-bold text-black" id="rep-expired-count">-</p>
                        </div>
                        <div class="text-center border-l border-slate-200">
                            <p class="text-xs text-slate-500 uppercase">Movimentações (30d)</p>
                            <p class="text-xl font-bold text-emerald-600" id="rep-movs">-</p>
                        </div>
                    </div>

                    <!-- Seção 1: Monitoramento de Validade -->
                    <div class="mb-8 break-inside-avoid">
                        <h3 class="text-lg font-bold text-slate-800 mb-2 border-b-2 border-slate-800 pb-1 flex items-center gap-2">
                            <i class="fa-solid fa-clock"></i> Monitoramento de Validade (Lote)
                        </h3>
                        <p class="text-xs text-slate-500 mb-2">Legenda: <span class="bg-black text-white px-1 rounded">Vencido</span> <span class="bg-red-100 text-red-800 px-1 rounded">7 Dias</span> <span class="bg-orange-100 text-orange-800 px-1 rounded">15 Dias</span> <span class="bg-yellow-100 text-yellow-800 px-1 rounded">30 Dias</span> <span class="bg-emerald-100 text-emerald-800 px-1 rounded">3 Meses</span></p>
                        
                        <table class="w-full text-sm">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Item</th>
                                    <th>Vencimento</th>
                                    <th>Dias Restantes</th>
                                    <th class="text-right">Qtd</th>
                                    <th class="text-right">Valor em Risco</th>
                                </tr>
                            </thead>
                            <tbody id="rep-validity-table"></tbody>
                        </table>
                        <p id="no-validity-msg" class="text-center text-slate-400 text-sm py-2 hidden">Nenhum item com vencimento próximo cadastrado.</p>
                    </div>

                    <!-- Seção 2: Necessidade de Compra -->
                    <div class="mb-8 break-inside-avoid">
                        <h3 class="text-lg font-bold text-slate-800 mb-2 border-b border-orange-200 pb-1 flex items-center gap-2 text-orange-700">
                            <i class="fa-solid fa-cart-shopping"></i> Sugestão de Compras (Reposição)
                        </h3>
                        <table class="w-full text-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Fornecedor / Ref</th>
                                    <th class="text-center">Atual</th>
                                    <th class="text-center">Mínimo</th>
                                    <th class="text-right">Comprar (+50%)</th>
                                </tr>
                            </thead>
                            <tbody id="rep-stock-table"></tbody>
                        </table>
                        <p id="no-stock-msg" class="text-center text-slate-400 text-sm py-2 hidden">Estoque em dia.</p>
                    </div>

                    <!-- Seção 3: Inventário Completo -->
                    <div class="break-inside-avoid">
                        <h3 class="text-lg font-bold text-slate-800 mb-2 border-b border-slate-200 pb-1">Inventário Geral</h3>
                        <table class="w-full text-xs">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Produto</th>
                                    <th>Localização</th>
                                    <th class="text-right">Qtd</th>
                                    <th class="text-right">Total (R$)</th>
                                </tr>
                            </thead>
                            <tbody id="rep-general-table"></tbody>
                        </table>
                    </div>

                    <div class="mt-8 text-center text-[10px] text-slate-400 pt-4 border-t border-slate-100">
                        Documento gerado em <span id="footerDate"></span>. Nexus Enterprise System.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scannerModal" class="fixed inset-0 bg-black z-[300] hidden flex flex-col">
        <div class="absolute top-0 w-full p-4 flex justify-between z-10 bg-gradient-to-b from-black/80 to-transparent">
            <span class="text-white font-bold"><i class="fa-solid fa-barcode"></i> Leitor</span>
            <button onclick="stopScanner()" class="bg-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="reader" class="w-full h-full bg-black"></div>
        <div class="absolute bottom-10 left-0 w-full text-center text-white/80 text-sm pointer-events-none">
            Aponte para o código de barras
        </div>
    </div>

    <!-- Modal Dados e Licença (Simplificado para o código) -->
    <div id="licenseModal" class="fixed inset-0 bg-slate-900/90 hidden z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-sm w-full p-6 text-center">
            <i class="fa-solid fa-crown text-4xl text-amber-500 mb-4 shadow-lg rounded-full p-2 bg-amber-100"></i>
            <h2 class="text-2xl font-bold mb-2">Nexus PRO</h2>
            <p class="text-slate-500 text-sm mb-4">ID do Dispositivo: <span class="font-mono bg-slate-100 px-2 rounded font-bold" id="deviceIdDisplay">...</span></p>
            <input type="text" id="licenseInput" class="w-full border p-2 rounded mb-3 text-center uppercase" placeholder="Chave de Ativação">
            <button onclick="activateLicense()" class="w-full bg-green-600 text-white py-2 rounded font-bold mb-2">Ativar</button>
            <button onclick="document.getElementById('licenseModal').classList.add('hidden')" class="text-slate-400 text-sm hover:underline">Fechar</button>
        </div>
    </div>

    <div id="dataModal" class="fixed inset-0 bg-slate-900/90 hidden z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-sm w-full p-6">
            <h3 class="font-bold text-lg mb-4">Gerenciar Dados</h3>
            <button onclick="exportData()" class="w-full bg-blue-100 text-blue-700 py-3 rounded-lg font-bold mb-3 flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> Backup (JSON)</button>
            <input type="file" id="importFile" class="hidden" onchange="importData(event)">
            <button onclick="document.getElementById('importFile').click()" class="w-full bg-orange-100 text-orange-700 py-3 rounded-lg font-bold flex items-center justify-center gap-2"><i class="fa-solid fa-upload"></i> Restaurar</button>
            <button onclick="document.getElementById('dataModal').classList.add('hidden')" class="w-full mt-4 text-slate-500 text-sm">Cancelar</button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl translate-y-24 transition-transform duration-300 z-[300] flex items-center gap-3">
        <i class="fa-solid fa-check-circle text-emerald-400"></i>
        <span id="toastMsg">Mensagem</span>
    </div>

    <script>
        // --- ESTADO & CONFIGURAÇÃO ---
        let items = JSON.parse(localStorage.getItem('nexus_items')) || [];
        let movements = JSON.parse(localStorage.getItem('nexus_movements')) || []; // Histórico de Movimentações
        let db;
        let html5QrcodeScanner = null;
        let scanTarget = null;
        let tempImageBase64 = null;
        let isLicensed = false;
        let deviceId = localStorage.getItem('nexus_device_id') || 'ID-' + Math.random().toString(36).substr(2,6).toUpperCase();
        
        localStorage.setItem('nexus_device_id', deviceId);

        // --- HELPER: CÁLCULO DE VALIDADE (NOVO) ---
        function getExpiryStatus(expiryDateStr) {
            if (!expiryDateStr) return null;
            
            const today = new Date();
            today.setHours(0,0,0,0);
            const expiry = new Date(expiryDateStr + 'T00:00:00');
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Lógica de Cores Solicitada
            if (diffDays < 0) {
                return { label: 'VENCIDO', colorClass: 'bg-black text-white', borderClass: 'border-black', days: diffDays, status: 'expired' };
            } else if (diffDays <= 7) {
                return { label: `Vence em ${diffDays} dias`, colorClass: 'bg-red-100 text-red-700', borderClass: 'border-red-500', days: diffDays, status: '7days' };
            } else if (diffDays <= 15) {
                return { label: `Vence em ${diffDays} dias`, colorClass: 'bg-orange-100 text-orange-700', borderClass: 'border-orange-500', days: diffDays, status: '15days' };
            } else if (diffDays <= 30) {
                return { label: `Vence em ${diffDays} dias`, colorClass: 'bg-yellow-100 text-yellow-800', borderClass: 'border-yellow-500', days: diffDays, status: '30days' };
            } else if (diffDays <= 90) { // 3 Meses
                return { label: `Vence em ${diffDays} dias`, colorClass: 'bg-emerald-100 text-emerald-700', borderClass: 'border-emerald-500', days: diffDays, status: '90days' };
            } else {
                return { label: 'Validade OK', colorClass: 'bg-slate-100 text-slate-500', borderClass: 'border-slate-200', days: diffDays, status: 'ok' };
            }
        }

        // --- SISTEMA DE DADOS (IndexedDB para Imagens) ---
        const initDB = () => {
            const req = indexedDB.open('NexusDB', 1);
            req.onupgradeneeded = (e) => e.target.result.createObjectStore('images', { keyPath: 'id' });
            req.onsuccess = (e) => db = e.target.result;
        };
        const saveImg = (id, data) => db.transaction(['images'], 'readwrite').objectStore('images').put({id: String(id), data});
        const getImg = (id) => new Promise(resolve => {
            if(!db) return resolve(null);
            const req = db.transaction(['images'], 'readonly').objectStore('images').get(String(id));
            req.onsuccess = (e) => resolve(e.target.result ? e.target.result.data : null);
            req.onerror = () => resolve(null);
        });

        // --- LICENCIAMENTO ---
        function checkLicense() {
            const savedKey = localStorage.getItem('nexus_license_key');
            const validKey = btoa(deviceId + "NEXUS").substring(0,10).toUpperCase();
            isLicensed = (savedKey === validKey);
            document.getElementById('deviceIdDisplay').innerText = deviceId;
            updateLicenseUI();
        }
        function activateLicense() {
            const input = document.getElementById('licenseInput').value.toUpperCase();
            const validKey = btoa(deviceId + "NEXUS").substring(0,10).toUpperCase();
            if(input === validKey) {
                localStorage.setItem('nexus_license_key', input);
                checkLicense();
                document.getElementById('licenseModal').classList.add('hidden');
                showToast("Licença PRO Ativada!");
            } else alert("Chave inválida");
        }
        function updateLicenseUI() {
            if(isLicensed) {
                document.getElementById('proBadge').classList.remove('hidden');
                document.getElementById('licenseStatusBanner').classList.add('hidden');
                document.getElementById('licenseDot').classList.replace('bg-red-500', 'bg-emerald-500');
                document.getElementById('licenseDot').classList.remove('animate-pulse');
            }
            document.getElementById('freeCountDisplay').innerText = items.length;
        }

        // --- CRUD ITENS ---
        async function renderItems() {
            const grid = document.getElementById('itemsGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;
            grid.innerHTML = '';

            const filtered = items.filter(i => {
                const matchSearch = i.name.toLowerCase().includes(search) || (i.barcode && i.barcode.includes(search));
                const matchType = typeFilter === 'all' || i.type === typeFilter;
                
                const expStatus = getExpiryStatus(i.expiry);
                let matchStatus = true;

                if(statusFilter === 'all') matchStatus = true;
                else if(statusFilter === 'low') matchStatus = i.qty <= i.minStock;
                else if(statusFilter === 'expired') matchStatus = expStatus && expStatus.status === 'expired';
                else if(statusFilter === '7days') matchStatus = expStatus && expStatus.status === '7days';
                else if(statusFilter === '15days') matchStatus = expStatus && expStatus.status === '15days';
                else if(statusFilter === '30days') matchStatus = expStatus && expStatus.status === '30days';
                
                return matchSearch && matchType && matchStatus;
            });

            if(filtered.length === 0) document.getElementById('emptyState').classList.remove('hidden');
            else document.getElementById('emptyState').classList.add('hidden');

            for (const item of filtered) {
                let imgHtml = `<div class="w-16 h-16 bg-slate-200 rounded-lg flex items-center justify-center text-slate-400"><i class="fa-solid fa-cube text-2xl"></i></div>`;
                if(item.hasImage) {
                    const b64 = await getImg(item.id);
                    if(b64) imgHtml = `<img src="${b64}" class="w-16 h-16 rounded-lg object-cover border border-slate-200">`;
                }

                // Lógica de Status (Visual do Card)
                const expInfo = getExpiryStatus(item.expiry);
                let borderClass = 'border-slate-200';
                let statusBadge = '';
                
                // Prioridade: Vencimento > Baixo Estoque
                if(expInfo && expInfo.status !== 'ok') {
                    borderClass = expInfo.borderClass + ' border-l-4';
                    statusBadge = `<span class="${expInfo.colorClass} text-[10px] font-bold px-2 py-0.5 rounded ml-1 uppercase whitespace-nowrap">${expInfo.label}</span>`;
                } else if(item.qty <= item.minStock) {
                    borderClass = 'border-orange-400 border-l-4';
                    statusBadge = `<span class="bg-orange-100 text-orange-700 text-[10px] font-bold px-2 py-0.5 rounded ml-1">REPOR</span>`;
                }

                const card = `
                <div class="bg-white p-4 rounded-xl border ${borderClass} card-hover flex flex-col justify-between">
                    <div class="flex gap-3 mb-3">
                        ${imgHtml}
                        <div class="overflow-hidden flex-grow">
                            <h4 class="font-bold text-slate-800 truncate" title="${item.name}">${item.name}</h4>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${statusBadge}
                            </div>
                            <p class="text-xs text-slate-400 mt-1 font-mono">${item.barcode || 'S/ Código'}</p>
                            <p class="text-xs text-slate-500"><i class="fa-solid fa-location-dot"></i> ${item.location || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-3 bg-slate-50 p-2 rounded">
                        <div>
                            <p class="text-[10px] text-slate-400 uppercase">Estoque</p>
                            <p class="font-bold text-indigo-600">${item.qty} <span class="text-xs text-slate-500">${item.unit}</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-slate-400 uppercase">Preço</p>
                            <p class="font-bold text-slate-700">R$ ${parseFloat(item.price).toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-auto">
                        <button onclick="openEditModal(${item.id})" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 py-2 rounded-lg text-sm font-medium transition"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="openQuickMove(${item.id})" class="flex-1 bg-emerald-50 hover:bg-emerald-100 text-emerald-600 py-2 rounded-lg text-sm font-medium transition border border-emerald-100" title="Movimentar"><i class="fa-solid fa-right-left"></i></button>
                    </div>
                </div>`;
                grid.innerHTML += card;
            }
            updateDashboard();
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const idVal = document.getElementById('itemId').value;
            const isNew = !idVal;
            
            if(isNew && !isLicensed && items.length >= 5) {
                return openLicenseModal();
            }

            const id = idVal ? parseInt(idVal) : Date.now();
            const data = {
                id,
                name: document.getElementById('itemName').value,
                barcode: document.getElementById('itemBarcode').value,
                type: document.getElementById('itemType').value,
                location: document.getElementById('itemLocation').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                qty: parseFloat(document.getElementById('itemQty').value),
                unit: document.getElementById('itemUnit').value,
                minStock: parseFloat(document.getElementById('itemMinStock').value),
                expiry: document.getElementById('itemExpiry').value,
                notes: document.getElementById('itemNotes').value,
                hasImage: !!tempImageBase64 || (items.find(i=>i.id===id)?.hasImage && tempImageBase64 !== null)
            };
            
            if(tempImageBase64) await saveImg(id, tempImageBase64);

            if(isNew) items.push(data);
            else {
                const idx = items.findIndex(i => i.id === id);
                items[idx] = data;
            }

            saveData();
            renderItems();
            closeModal();
            showToast(isNew ? "Item Criado!" : "Item Atualizado!");
        }

        // --- MOVIMENTAÇÕES ---
        function openMovementModal() {
            document.getElementById('movementForm').reset();
            document.getElementById('movProductCard').classList.add('hidden');
            document.getElementById('movDetailsSection').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('btnConfirmMov').disabled = true;
            document.getElementById('btnConfirmMov').classList.add('cursor-not-allowed', 'bg-slate-400');
            document.getElementById('btnConfirmMov').classList.remove('bg-indigo-600', 'bg-red-600', 'hover:bg-indigo-700', 'hover:bg-red-700');
            
            const now = new Date();
            document.getElementById('movDate').valueAsDate = now;
            document.getElementById('movTime').value = now.toTimeString().substring(0,5);
            
            document.getElementById('movementModal').classList.remove('hidden');
            document.getElementById('movSearch').focus();
        }

        function closeMovementModal() {
            document.getElementById('movementModal').classList.add('hidden');
            stopScanner();
        }

        function searchProductForMovement() {
            const query = document.getElementById('movSearch').value.toLowerCase();
            const results = document.getElementById('movSearchResults');
            results.innerHTML = '';
            
            if(query.length < 2) {
                results.classList.add('hidden');
                return;
            }

            const matches = items.filter(i => i.name.toLowerCase().includes(query) || (i.barcode && i.barcode.includes(query)) || String(i.id).includes(query));
            
            if(matches.length > 0) {
                results.classList.remove('hidden');
                matches.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "p-3 hover:bg-indigo-50 cursor-pointer border-b border-slate-100 flex justify-between items-center";
                    div.innerHTML = `<div><p class='font-bold text-sm'>${item.name}</p><p class='text-xs text-slate-500'>${item.barcode || 'S/ Cod'}</p></div> <span class='text-xs font-bold bg-slate-200 px-2 rounded'>${item.qty} ${item.unit}</span>`;
                    div.onclick = () => selectProductForMov(item);
                    results.appendChild(div);
                });
            } else {
                results.classList.add('hidden');
            }
        }

        function selectProductForMov(item) {
            document.getElementById('movSearchResults').classList.add('hidden');
            document.getElementById('movSearch').value = '';
            document.getElementById('movItemId').value = item.id;
            document.getElementById('movProductName').innerText = item.name;
            document.getElementById('movCurrentStock').innerText = item.qty;
            document.getElementById('movUnit').innerText = item.unit;
            document.getElementById('movProductImg').innerHTML = item.hasImage ? '<i class="fa-solid fa-check text-green-500"></i>' : '<i class="fa-solid fa-image"></i>';

            document.getElementById('movProductCard').classList.remove('hidden');
            document.getElementById('movDetailsSection').classList.remove('opacity-50', 'pointer-events-none');
            updateMovLabels();
            document.getElementById('movQty').focus();
        }

        function clearMovSelection() {
            document.getElementById('movProductCard').classList.add('hidden');
            document.getElementById('movDetailsSection').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('btnConfirmMov').disabled = true;
            document.getElementById('btnConfirmMov').classList.add('cursor-not-allowed', 'bg-slate-400');
            document.getElementById('btnConfirmMov').className = "w-2/3 bg-slate-400 text-white py-3 rounded-lg font-bold transition shadow-md flex items-center justify-center gap-2 cursor-not-allowed";
        }

        function updateMovLabels() {
            const type = document.getElementById('movType').value;
            const btn = document.getElementById('btnConfirmMov');
            const labelSD = document.getElementById('labelSourceDest');

            btn.disabled = false;
            btn.classList.remove('cursor-not-allowed', 'bg-slate-400', 'bg-indigo-600', 'bg-red-600', 'hover:bg-indigo-700', 'hover:bg-red-700');

            if(type === 'in') {
                btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                btn.innerHTML = '<i class="fa-solid fa-download"></i> Confirmar Entrada';
                labelSD.innerText = "Origem / Fornecedor";
                document.getElementById('movSourceDest').placeholder = "Ex: Distribuidora XYZ";
            } else {
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                btn.innerHTML = '<i class="fa-solid fa-upload"></i> Confirmar Saída';
                labelSD.innerText = "Destino / Cliente / Setor";
                document.getElementById('movSourceDest').placeholder = "Ex: Linha de Produção B";
            }
        }

        function openQuickMove(id) {
            const item = items.find(i => i.id === id);
            if(item) {
                openMovementModal();
                selectProductForMov(item);
            }
        }

        function handleMovementSubmit(e) {
            e.preventDefault();
            const itemId = parseInt(document.getElementById('movItemId').value);
            const itemIdx = items.findIndex(i => i.id === itemId);
            if(itemIdx === -1) return;

            const type = document.getElementById('movType').value;
            const qty = parseFloat(document.getElementById('movQty').value);
            const sourceDest = document.getElementById('movSourceDest').value;
            const dateStr = document.getElementById('movDate').value;
            const timeStr = document.getElementById('movTime').value;

            if(type === 'in') items[itemIdx].qty += qty;
            else items[itemIdx].qty -= qty;

            movements.push({
                id: Date.now(),
                itemId: itemId,
                itemName: items[itemIdx].name,
                type: type,
                qty: qty,
                unit: items[itemIdx].unit,
                sourceDest: sourceDest,
                date: dateStr,
                time: timeStr,
                balanceAfter: items[itemIdx].qty
            });

            if(movements.length > 500) movements.shift();

            localStorage.setItem('nexus_movements', JSON.stringify(movements));
            saveData();
            renderItems();
            closeMovementModal();
            showToast(type === 'in' ? "Entrada Registrada!" : "Saída Registrada!");
        }

        // --- SCANNER ---
        function startScanner(mode) {
            scanTarget = mode;
            document.getElementById('scannerModal').classList.remove('hidden');
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
            (decodedText) => {
                stopScanner();
                if(scanTarget === 'form') document.getElementById('itemBarcode').value = decodedText;
                else if(scanTarget === 'search') {
                    document.getElementById('searchInput').value = decodedText;
                    renderItems();
                } else if(scanTarget === 'movement') {
                    document.getElementById('movSearch').value = decodedText;
                    searchProductForMovement();
                    const matches = items.filter(i => i.barcode === decodedText);
                    if(matches.length === 1) selectProductForMov(matches[0]);
                }
                showToast("Código Lido: " + decodedText);
            });
        }
        function stopScanner() {
            if(html5QrcodeScanner) html5QrcodeScanner.stop().catch(err=>{});
            document.getElementById('scannerModal').classList.add('hidden');
        }

        // --- RELATÓRIOS ---
        function generateReport() {
            const now = new Date();
            document.getElementById('reportDate').innerText = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            document.getElementById('footerDate').innerText = now.toLocaleString();

            let totalVal = 0, totalItems = 0, lowStock = 0, expiredCount = 0;
            
            const tbodyStock = document.getElementById('rep-stock-table');
            const tbodyValidity = document.getElementById('rep-validity-table');
            const tbodyGen = document.getElementById('rep-general-table');
            
            tbodyStock.innerHTML = '';
            tbodyValidity.innerHTML = '';
            tbodyGen.innerHTML = '';
            
            let hasStockIssues = false;
            let hasValidityIssues = false;
            let validityList = [];

            items.forEach(i => {
                totalVal += i.price * i.qty;
                totalItems++;
                if(i.qty <= i.minStock) lowStock++;

                // Checagem de Validade
                const exp = getExpiryStatus(i.expiry);
                if(exp && exp.status !== 'ok') {
                    if(exp.status === 'expired') expiredCount++;
                    validityList.push({ ...i, ...exp });
                    hasValidityIssues = true;
                }

                tbodyGen.innerHTML += `
                    <tr>
                        <td>${i.barcode || i.id}</td>
                        <td>${i.name}</td>
                        <td>${i.location || '-'}</td>
                        <td class="text-right font-bold">${i.qty} ${i.unit}</td>
                        <td class="text-right">R$ ${(i.price * i.qty).toFixed(2)}</td>
                    </tr>
                `;

                if(i.qty <= i.minStock) {
                    hasStockIssues = true;
                    const buyQty = (i.minStock * 1.5) - i.qty;
                    tbodyStock.innerHTML += `
                        <tr>
                            <td class="font-bold text-slate-700">${i.name}</td>
                            <td class="text-xs text-slate-500">${i.location || 'Sem Loc.'}</td>
                            <td class="text-center text-red-600 font-bold">${i.qty}</td>
                            <td class="text-center text-slate-500">${i.minStock}</td>
                            <td class="text-right font-bold text-indigo-600">+${buyQty.toFixed(2)} ${i.unit}</td>
                        </tr>
                    `;
                }
            });

            // Ordenar Lista de Validade (Mais urgente primeiro)
            validityList.sort((a, b) => a.days - b.days);

            // Renderizar Tabela de Validade com Cores Específicas
            validityList.forEach(v => {
                let rowBg = '';
                // Mapeamento para estilos de impressão
                if (v.status === 'expired') rowBg = 'print-bg-black';
                else if (v.status === '7days') rowBg = 'print-bg-red';
                else if (v.status === '15days') rowBg = 'print-bg-orange';
                else if (v.status === '30days') rowBg = 'print-bg-yellow';
                else if (v.status === '90days') rowBg = 'print-bg-green';

                tbodyValidity.innerHTML += `
                    <tr class="${rowBg}">
                        <td class="font-bold uppercase text-xs">${v.label}</td>
                        <td>${v.name}</td>
                        <td>${new Date(v.expiry).toLocaleDateString()}</td>
                        <td>${v.days} dias</td>
                        <td class="text-right font-bold">${v.qty}</td>
                        <td class="text-right">R$ ${(v.qty * v.price).toFixed(2)}</td>
                    </tr>
                `;
            });

            if(!hasValidityIssues) {
                document.getElementById('no-validity-msg').classList.remove('hidden');
                document.getElementById('rep-validity-table').parentElement.classList.add('hidden');
            } else {
                document.getElementById('no-validity-msg').classList.add('hidden');
                document.getElementById('rep-validity-table').parentElement.classList.remove('hidden');
            }

            if(!hasStockIssues) {
                document.getElementById('no-stock-msg').classList.remove('hidden');
                document.getElementById('rep-stock-table').parentElement.classList.add('hidden');
            } else {
                document.getElementById('no-stock-msg').classList.add('hidden');
                document.getElementById('rep-stock-table').parentElement.classList.remove('hidden');
            }

            document.getElementById('rep-total').innerText = 'R$ ' + totalVal.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('rep-items').innerText = totalItems;
            // Removed erroneous line: document.getElementById('rep-low').innerText = lowStock;
            document.getElementById('rep-expired-count').innerText = expiredCount;
            
            // Stats de Movimentação
            const recentMovs = movements.sort((a,b) => b.id - a.id).slice(0, 50);
            document.getElementById('rep-movs').innerText = recentMovs.length;

            document.getElementById('reportModal').classList.remove('hidden');
        }

        function closeReport() { document.getElementById('reportModal').classList.add('hidden'); }

        // --- UTILS ---
        function saveData() {
            localStorage.setItem('nexus_items', JSON.stringify(items));
            updateDashboard();
            updateLicenseUI();
        }

        function updateDashboard() {
            let val = 0;
            let low = 0;
            let exp = 0;
            items.forEach(i => {
                val += i.price * i.qty;
                if(i.qty <= i.minStock) low++;
                
                const st = getExpiryStatus(i.expiry);
                if(st && (st.status === 'expired' || st.status === '7days' || st.status === '15days')) exp++;
            });
            document.getElementById('stat-total-value').innerText = val.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('stat-total-items').innerText = items.length;
            document.getElementById('stat-low-stock').innerText = low;
            document.getElementById('stat-expiring').innerText = exp;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('translate-y-24');
            setTimeout(() => t.classList.add('translate-y-24'), 3000);
        }

        // Modals & Reset
        function openModal() { 
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('modalTitle').innerText = "Novo Item";
            document.getElementById('itemModal').classList.remove('hidden');
            tempImageBase64 = null;
            document.getElementById('imagePreview').innerHTML = '<i class="fa-solid fa-camera text-3xl mb-2"></i><span class="text-xs">Adicionar Foto</span>';
            document.getElementById('btnClearImage').classList.add('hidden');
        }
        function closeModal() { document.getElementById('itemModal').classList.add('hidden'); }
        function openEditModal(id) {
            const item = items.find(i => i.id === id);
            if(!item) return;
            openModal();
            document.getElementById('modalTitle').innerText = "Editar Item";
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemBarcode').value = item.barcode || '';
            document.getElementById('itemType').value = item.type;
            document.getElementById('itemLocation').value = item.location || '';
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemQty').value = item.qty;
            document.getElementById('itemUnit').value = item.unit;
            document.getElementById('itemMinStock').value = item.minStock;
            document.getElementById('itemExpiry').value = item.expiry || '';
            document.getElementById('itemNotes').value = item.notes || '';

            if(item.hasImage) {
                getImg(item.id).then(b64 => {
                    if(b64) {
                        document.getElementById('imagePreview').innerHTML = `<img src="${b64}" class="w-full h-full object-cover">`;
                        document.getElementById('btnClearImage').classList.remove('hidden');
                    }
                });
            }
        }
        
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = Math.min(500/img.width, 500/img.height, 1);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    tempImageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('imagePreview').innerHTML = `<img src="${tempImageBase64}" class="w-full h-full object-cover">`;
                    document.getElementById('btnClearImage').classList.remove('hidden');
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }
        function clearImage() {
            tempImageBase64 = null;
            document.getElementById('imagePreview').innerHTML = '<i class="fa-solid fa-camera text-3xl mb-2"></i><span class="text-xs">Adicionar Foto</span>';
            document.getElementById('btnClearImage').classList.add('hidden');
        }

        function checkLimitAndOpenModal() {
            if(!isLicensed && items.length >= 5) openLicenseModal();
            else openModal();
        }
        function openLicenseModal() { document.getElementById('licenseModal').classList.remove('hidden'); }
        function openDataModal() { document.getElementById('dataModal').classList.remove('hidden'); }
        
        function exportData() {
            const data = { items, movements };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Nexus_Backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }
        function importData(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if(data.items && Array.isArray(data.items)) {
                        if(confirm("Restaurar backup substituirá dados atuais. Continuar?")) {
                            items = data.items;
                            movements = data.movements || [];
                            saveData();
                            localStorage.setItem('nexus_movements', JSON.stringify(movements));
                            renderItems();
                            document.getElementById('dataModal').classList.add('hidden');
                            showToast("Backup Restaurado!");
                        }
                    } else alert("Formato inválido");
                } catch(err) { alert("Erro ao ler arquivo"); }
            };
            reader.readAsText(file);
        }

        window.addEventListener('load', () => {
            initDB();
            checkLicense();
            renderItems();
        });

        const style = document.createElement('style');
        style.innerHTML = `
            .input-field { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 0.5rem; outline: none; transition: border-color 0.2s; }
            .input-field:focus { border-color: #6366f1; ring: 2px solid #e0e7ff; }
            .label-text { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem; }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>
